# Upstream servers configuration
# Define backend services that nginx will proxy requests to

# Booking service backend
upstream booking {
    server booking:5001;  # Docker service name and port
}

# Catalogue service backend
upstream catalogue {
    server catalogue:5002;  # Docker service name and port
}

# Main server block - handles all incoming HTTP requests
server {
    listen 80;  # Listen on port 80 for HTTP traffic
    server_name localhost;

    # Shared assets - served directly by nginx for optimal performance
    # These are common assets (CSS, JS) used across all microsites
    location /shared/ {
        alias /usr/share/nginx/shared/;  # Map to nginx shared directory
        expires 1h;  # Cache for 1 hour
        add_header Cache-Control "public, immutable";  # Tell browsers these files don't change
    }

    # Booking microsite - handles reservation functionality
    # Accessible at: http://localhost/booking
    location /booking {
        proxy_pass http://booking;  # Forward to booking upstream server
        proxy_http_version 1.1;  # Use HTTP/1.1 for better performance
        proxy_set_header Upgrade $http_upgrade;  # Enable WebSocket support
        proxy_set_header Connection 'upgrade';  # Enable WebSocket support
        proxy_set_header Host $host;  # Pass original host header
        proxy_set_header X-Real-IP $remote_addr;  # Pass client's real IP
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # Pass proxy chain
        proxy_set_header X-Forwarded-Proto $scheme;  # Pass original protocol (http/https)
        proxy_cache_bypass $http_upgrade;  # Don't cache WebSocket connections
    }

    # Catalogue microsite - displays product listings
    # Accessible at: http://localhost/catalogue/
    # The trailing slash in proxy_pass strips the /catalogue prefix before forwarding
    location /catalogue/ {
        proxy_pass http://catalogue/;  # Forward to catalogue upstream, stripping /catalogue
        proxy_http_version 1.1;  # Use HTTP/1.1 for better performance
        proxy_set_header Host $host;  # Pass original host header
        proxy_set_header X-Real-IP $remote_addr;  # Pass client's real IP
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # Pass proxy chain
        proxy_set_header X-Forwarded-Proto $scheme;  # Pass original protocol (http/https)
    }

    # Redirect /catalogue (without trailing slash) to /catalogue/
    # This ensures consistent URL handling
    location = /catalogue {
        return 301 /catalogue/;  # Permanent redirect (301)
    }

    # Root path handler - default landing page
    # Redirects visitors to the booking microsite
    location / {
        return 302 /booking;  # Temporary redirect (302) to booking service
    }
}
